<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge;chrome=1" />
    <title>[ IE TextRanges, Selections, and Carriage Returns ].blue</title>
    <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" />

    <link href="http://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css" media="(min-width: 767px)">
    <link href="/stylesheets/normalize.css" rel="stylesheet" type="text/css" /><link href="/stylesheets/layout.css" rel="stylesheet" type="text/css" /><link href="/stylesheets/syntax-theme.css" rel="stylesheet" type="text/css" /><link href="/stylesheets/theme.css" rel="stylesheet" type="text/css" /><link href="/stylesheets/icons.css" rel="stylesheet" type="text/css" />

    <script src="/javascripts/all.js" type="text/javascript"></script>
  </head>

  <body class="blog blog_2009 blog_2009_ie-textranges-selections-and-carriage-returns">
    <header class="page">
      <h1><a href="/">[ ].blue</a></h1>
      <h6>Blog of Titus Stone</h6>
    </header>
    <main>

        <article>
          <h1 class="title">IE TextRanges, Selections, and Carriage Returns</h1>

      <p>I spent several hours this week trying to track down a bug with programmatically selecting text via javascript.</p>
<div class="highlight javascript"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12</pre></td><td class="code"><pre><span class="k">if</span> <span class="p">(</span><span class="nx">textarea</span><span class="p">.</span><span class="nx">setSelectionRange</span><span class="p">)</span> <span class="p">{</span>
<span class="c1">// Set selection for Mozilla-ish browsers</span>
    <span class="nx">textarea</span><span class="p">.</span><span class="nx">setSelectionRange</span><span class="p">(</span><span class="nx">start</span><span class="p">,</span> <span class="nx">end</span><span class="p">);</span>
 <span class="p">}</span>
<span class="k">else</span> <span class="p">{</span>
<span class="c1">// Set selection for IE</span>
    <span class="kd">var</span> <span class="nx">range</span> <span class="o">=</span> <span class="nx">textarea</span><span class="p">.</span><span class="nx">createTextRange</span><span class="p">();</span>
 <span class="nx">range</span><span class="p">.</span><span class="nx">collapse</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
 <span class="nx">range</span><span class="p">.</span><span class="nx">moveEnd</span><span class="p">(</span><span class="s1">'character'</span><span class="p">,</span> <span class="nx">start</span><span class="p">);</span>
 <span class="nx">range</span><span class="p">.</span><span class="nx">moveStart</span><span class="p">(</span><span class="s1">'character'</span><span class="p">,</span> <span class="nx">end</span><span class="p">);</span>
 <span class="nx">range</span><span class="p">.</span><span class="nx">select</span><span class="p">();</span>
<span class="p">}</span>
</pre></td></tr></tbody></table>
</div>

<p>Assuming that <code>textarea</code> is the element of the <code>&lt;textarea&gt;</code>, and <code>start</code> and <code>end</code> are Number values that indicate the start and end of the selection, respectively.</p>

<p>I was managing this in MarkEdit by keeping a state object that recorded the “Before Select” (everything before the selection), the selection text, and the “After Select” (everything after the selection).</p>

<p>So it seems easy to implement right?</p>
<div class="highlight javascript"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre><span class="nx">start</span> <span class="o">=</span> <span class="nx">beforeSelect</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
<span class="nx">end</span> <span class="o">=</span> <span class="nx">start</span> <span class="o">+</span> <span class="nx">select</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
</pre></td></tr></tbody></table>
</div>

<p><strong>That doesn’t always work!</strong></p>

<p>It works sometimes, but occasionally the selection will be the proper length, but randomly offset by 3-7 characters. It took quite a bit to figure out (that’s an understatement). Here’s what a lot of debugging and experimentation came up with:</p>

<p>When Internet Explorer creates a Range or a TextRange object, it converts all line returns to Carriage Return/Line Feed format; basically <code>[0A] -&gt; [0D 0A]</code>. Easy to counter? Just determine all the instances of <code>[0D]</code> and <code>[0A]</code>, subtract the two, then you have the offset? That’s what I thought too, but even with the offset, the discrepancy persisted.</p>

<p>So it was time for a new approach. What if we converted all of the <code>[0A]</code> characters in the textarea to <code>[0D 0A]</code>’s ? Again, the offset of the selection persisted.</p>

<p>Here’s what I finally narrowed it down to be: When you create a <code>TextRange</code>, IE doesn’t actually re-render the text internally, converting all [0A]’s. However, when you request the text (<code>TextRange.text</code>) it converts it at that time. This means if you were to get the length of the selected text, <code>TextRange.text.length</code>, it would be longer than what the <code>TextRange</code> is seeing internally! When using <code>.moveEnd</code> on the <code>TextRange</code>, the value counts the position from the internal text, not from the text it gives you.</p>

<p>That is reeeeeeediculously wrong. The final solution is to “sanitize” the text <code>TextRange</code> gives you by removing all <code>[0D]</code> characters from it. From there you can accurately calculate the selection position and give the <code>TextRange</code> the proper coordinates.</p>

<p>Whew… that was several hours needlessly wasted by IE (again).</p>


        </article>

    </main>
    <footer>
      <span>&copy; Titus Stone</span>
      <a href="http://github.com/tstone">Github</a>
      <a href="http://twitter.com/andstuff">Twitter</a>
    </footer>
  </body>
</html>
